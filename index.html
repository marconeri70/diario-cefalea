<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Diario Cefalea</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <img class="logo" src="./assets/ptv.png" alt="Fondazione PTV" />
      <div class="brand-text">
        <div class="brand-title">Diario Cefalea</div>
        <div class="brand-subtitle">Registro ‚Ä¢ Trigger ‚Ä¢ Grafici ‚Ä¢ Report PDF</div>
      </div>
    </div>

    <div class="header-actions">
      <button id="btnInstall" class="btn btn-ghost" hidden>‚¨áÔ∏è Installa</button>

      <div class="header-field">
        <div class="label">Data</div>
        <input id="globalDate" type="date" class="input" />
      </div>

      <div class="header-field">
        <div class="label">Mese</div>
        <input id="month" type="month" class="input" />
      </div>

      <div class="header-field">
        <div class="label">Tema</div>
        <select id="themeSelect" class="input">
          <option value="auto">Auto</option>
          <option value="dark">Scuro</option>
          <option value="light">Chiaro</option>
        </select>
      </div>
    </div>
  </header>

  <nav class="tabs" aria-label="Navigazione">
    <button class="tab active" data-view="diario" data-accent="blue" type="button">
      <span class="tab-ico">üìù</span><span>Diario</span>
    </button>
    <button class="tab" data-view="statistiche" data-accent="cyan" type="button">
      <span class="tab-ico">üìä</span><span>Statistiche</span>
    </button>
    <button class="tab" data-view="report" data-accent="amber" type="button">
      <span class="tab-ico">üßæ</span><span>Report PDF</span>
    </button>
    <button class="tab" data-view="impostazioni" data-accent="violet" type="button">
      <span class="tab-ico">‚öôÔ∏è</span><span>Impostazioni</span>
    </button>
  </nav>

  <main class="container">
    <!-- =======================
         DIARIO
         ======================= -->
    <section id="view-diario" class="view active">
      <div class="card" id="card-form">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Inserisci attacco</h2>
            <p class="muted">Compila i campi principali e aggiungi trigger / sede dolore / note se necessario.</p>
          </div>
          <div class="pill">Touch-friendly</div>
        </div>

        <form id="attackForm" class="form">
          <div class="grid">
            <div class="field">
              <label class="label" for="date">Data</label>
              <input id="date" class="input" type="date" />
              <div class="hint">Suggerimento: la data qui aggiorna automaticamente anche la data globale.</div>
            </div>

            <div class="field">
              <label class="label" for="time">Ora (opzionale)</label>
              <input id="time" class="input" type="time" />
            </div>

            <div class="field">
              <label class="label" for="intensity">Intensit√† (1‚Äì10)</label>
              <input id="intensity" class="input" type="number" min="1" max="10" step="1" placeholder="Es. 7" />
            </div>

            <div class="field">
              <label class="label" for="duration">Durata (ore)</label>
              <input id="duration" class="input" type="number" min="0.5" step="0.5" placeholder="Es. 6" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="meds">Farmaci assunti (selezione multipla)</label>
            <select id="meds" class="input" multiple size="6">
              <option value="Relpax">Relpax</option>
              <option value="Okitask (FANS)">Okitask (FANS)</option>
              <option value="Ibuprofene (FANS)">Ibuprofene (FANS)</option>
              <option value="Naproxene (FANS)">Naproxene (FANS)</option>
              <option value="Paracetamolo">Paracetamolo</option>
              <option value="Altro (FANS)">Altro (FANS)</option>
              <option value="Nessuno">Nessuno</option>
            </select>
            <div class="hint">Tip: su Android puoi tenere premuto e selezionare pi√π opzioni.</div>
          </div>

          <div class="grid">
            <div class="field">
              <label class="label" for="efficacy">Risposta ai farmaci</label>
              <select id="efficacy" class="input">
                <option value="Nessuna">Nessuna</option>
                <option value="Parziale" selected>Parziale</option>
                <option value="Buona">Buona</option>
                <option value="Ottima">Ottima</option>
              </select>
            </div>

            <div class="field">
              <label class="label" for="stress">Stress (0‚Äì10) <span class="badge-mini" id="stressVal">0</span></label>
              <input id="stress" class="input" type="range" min="0" max="10" step="1" value="0" />
              <div class="hint">Valore indicativo (pi√π alto = pi√π stress).</div>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <label class="label" for="sleepHours">Ore di sonno (opzionale)</label>
              <input id="sleepHours" class="input" type="number" min="0" max="24" step="0.5" placeholder="Es. 5.5" />
            </div>
            <div class="field">
              <label class="label" for="weather">Meteo (opzionale)</label>
              <input id="weather" class="input" type="text" placeholder="Es. pioggia / sbalzo temperatura" />
            </div>
            <div class="field">
              <label class="label" for="foods">Alimenti (opzionale)</label>
              <input id="foods" class="input" type="text" placeholder="Es. cioccolato, vino, salumi..." />
            </div>
          </div>

          <div class="field">
            <label class="label">Trigger (spuntare se presenti)</label>
            <div id="triggerChips" class="chips">
              <label class="chip"><input type="checkbox" value="Stress" /> Stress</label>
              <label class="chip"><input type="checkbox" value="Poco sonno" /> Poco sonno</label>
              <label class="chip"><input type="checkbox" value="Meteo" /> Meteo</label>
              <label class="chip"><input type="checkbox" value="Alimenti" /> Alimenti</label>
              <label class="chip"><input type="checkbox" value="Luci/Schermi" /> Luci/Schermi</label>
              <label class="chip"><input type="checkbox" value="Rumore" /> Rumore</label>
              <label class="chip"><input type="checkbox" value="Fatica" /> Fatica</label>
              <label class="chip"><input type="checkbox" value="Ciclo/Ormoni" /> Ciclo/Ormoni</label>
              <label class="chip"><input type="checkbox" value="Collo/Tensione" /> Collo/Tensione</label>
            </div>
            <div class="hint">Nota: alcuni trigger possono essere dedotti automaticamente (es. stress alto, poco sonno).</div>
          </div>

          <!-- ‚úÖ POSIZIONE DOLORE -->
          <div class="painmap-card">
            <div class="painmap-head">
              <div>
                <div class="painmap-title">Posizione del tuo dolore</div>
                <div class="muted" style="font-size:12px; margin-top:2px">
                  Tocca le zone: puoi selezionare pi√π aree (anche sinistra + destra insieme).
                </div>
              </div>

              <div class="painmap-actions">
                <button id="painClear" type="button" class="btn btn-ghost">Pulisci</button>
              </div>
            </div>

            <div class="painmap-controls">
              <button type="button" class="seg active" data-painview="front">Davanti</button>
              <button type="button" class="seg" data-painview="left">Sinistra</button>
              <button type="button" class="seg" data-painview="right">Destra</button>
            </div>

            <div class="painmap-wrap">
              <!-- FRONT -->
              <div class="painmap-view active" data-painview="front">
                <svg class="headsvg" viewBox="0 0 360 420" role="img" aria-label="Mappa testa frontale">
                  <defs>
                    <radialGradient id="skinGradF" cx="45%" cy="35%" r="70%">
                      <stop offset="0%" stop-color="rgba(120,195,255,.90)"/>
                      <stop offset="55%" stop-color="rgba(55,140,230,.70)"/>
                      <stop offset="100%" stop-color="rgba(10,50,120,.80)"/>
                    </radialGradient>
                    <linearGradient id="shineF" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="rgba(255,255,255,.35)"/>
                      <stop offset="60%" stop-color="rgba(255,255,255,.05)"/>
                      <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
                    </linearGradient>
                    <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
                      <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(0,0,0,.25)"/>
                    </filter>
                  </defs>

                  <!-- head base -->
                  <path filter="url(#softShadow)"
                    d="M180 28
                       C118 28,72 76,72 143
                       C72 178,83 208,96 236
                       C106 259,112 285,110 312
                       C106 365,136 392,180 404
                       C224 392,254 365,250 312
                       C248 285,254 259,264 236
                       C277 208,288 178,288 143
                       C288 76,242 28,180 28 Z"
                    fill="url(#skinGradF)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>

                  <!-- subtle facial guidelines -->
                  <path d="M180 86 C162 104,162 132,180 150 C198 132,198 104,180 86Z"
                        fill="rgba(255,255,255,.10)"/>
                  <path d="M120 170 C150 160,210 160,240 170"
                        fill="none" stroke="rgba(255,255,255,.18)" stroke-width="3" stroke-linecap="round"/>
                  <path d="M140 250 C160 265,200 265,220 250"
                        fill="none" stroke="rgba(255,255,255,.16)" stroke-width="4" stroke-linecap="round"/>
                  <path d="M180 150 L180 250"
                        fill="none" stroke="rgba(255,255,255,.10)" stroke-width="2"/>

                  <!-- shine -->
                  <path d="M100 90 C120 55,165 42,205 54 C165 64,135 105,120 150 C112 175,108 210,110 240 C92 210,86 140,100 90 Z"
                        fill="url(#shineF)"/>

                  <!-- ZONES (clickable) -->
                  <g class="zones">
                    <!-- fronte sx / dx -->
                    <path class="zone" data-zone="fronte_sx"
                      d="M110 78 C125 58,150 48,170 52 C155 70,145 98,140 125 C130 120,118 102,110 78 Z"/>
                    <path class="zone" data-zone="fronte_dx"
                      d="M250 78 C235 58,210 48,190 52 C205 70,215 98,220 125 C230 120,242 102,250 78 Z"/>

                    <!-- tempia sx / dx -->
                    <path class="zone" data-zone="tempia_sx"
                      d="M92 140 C98 116,112 104,130 110 C125 140,122 168,128 190 C110 188,96 170,92 140 Z"/>
                    <path class="zone" data-zone="tempia_dx"
                      d="M268 140 C262 116,248 104,230 110 C235 140,238 168,232 190 C250 188,264 170,268 140 Z"/>

                    <!-- orbitale sx / dx -->
                    <path class="zone" data-zone="orbitale_sx"
                      d="M118 170 C140 155,160 155,172 170 C160 186,140 186,118 170 Z"/>
                    <path class="zone" data-zone="orbitale_dx"
                      d="M242 170 C220 155,200 155,188 170 C200 186,220 186,242 170 Z"/>

                    <!-- zigomo sx/dx -->
                    <path class="zone" data-zone="zigomo_sx"
                      d="M112 200 C130 192,150 198,160 214 C144 228,128 228,112 200 Z"/>
                    <path class="zone" data-zone="zigomo_dx"
                      d="M248 200 C230 192,210 198,200 214 C216 228,232 228,248 200 Z"/>

                    <!-- mandibola sx/dx -->
                    <path class="zone" data-zone="mandibola_sx"
                      d="M120 252 C136 238,150 236,164 248 C154 282,138 288,120 252 Z"/>
                    <path class="zone" data-zone="mandibola_dx"
                      d="M240 252 C224 238,210 236,196 248 C206 282,222 288,240 252 Z"/>

                    <!-- nuca/collo (front: zona bassa centrale) -->
                    <path class="zone" data-zone="cervicale"
                      d="M150 306 C160 292,200 292,210 306 C208 340,152 340,150 306 Z"/>
                  </g>
                </svg>
              </div>

              <!-- LEFT -->
              <div class="painmap-view" data-painview="left">
                <svg class="headsvg" viewBox="0 0 360 420" role="img" aria-label="Mappa testa sinistra">
                  <defs>
                    <radialGradient id="skinGradL" cx="40%" cy="30%" r="75%">
                      <stop offset="0%" stop-color="rgba(120,195,255,.92)"/>
                      <stop offset="55%" stop-color="rgba(55,140,230,.72)"/>
                      <stop offset="100%" stop-color="rgba(10,50,120,.82)"/>
                    </radialGradient>
                    <filter id="softShadowL" x="-30%" y="-30%" width="160%" height="160%">
                      <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(0,0,0,.25)"/>
                    </filter>
                  </defs>

                  <!-- side head base -->
                  <path filter="url(#softShadowL)"
                    d="M210 34
                       C150 40,108 84,104 146
                       C101 198,118 236,138 262
                       C150 278,152 300,146 320
                       C135 356,155 392,210 404
                       C248 398,270 372,276 344
                       C282 316,274 288,266 266
                       C290 236,304 202,300 160
                       C296 94,260 42,210 34 Z"
                    fill="url(#skinGradL)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>

                  <!-- ear hint -->
                  <ellipse cx="260" cy="210" rx="18" ry="26" fill="rgba(255,255,255,.10)"/>

                  <g class="zones">
                    <path class="zone" data-zone="tempia_sx"
                      d="M132 150 C140 120,162 104,186 108 C178 142,176 170,186 198 C160 198,140 184,132 150 Z"/>
                    <path class="zone" data-zone="occipite_sx"
                      d="M200 108 C230 112,254 142,258 184 C238 174,220 176,206 186 C198 162,196 136,200 108 Z"/>
                    <path class="zone" data-zone="mandibola_sx"
                      d="M154 258 C172 238,194 240,208 254 C206 290,176 300,154 258 Z"/>
                    <path class="zone" data-zone="cervicale"
                      d="M164 304 C176 288,214 290,224 306 C220 342,170 342,164 304 Z"/>
                  </g>
                </svg>
              </div>

              <!-- RIGHT -->
              <div class="painmap-view" data-painview="right">
                <svg class="headsvg" viewBox="0 0 360 420" role="img" aria-label="Mappa testa destra">
                  <defs>
                    <radialGradient id="skinGradR" cx="60%" cy="30%" r="75%">
                      <stop offset="0%" stop-color="rgba(120,195,255,.92)"/>
                      <stop offset="55%" stop-color="rgba(55,140,230,.72)"/>
                      <stop offset="100%" stop-color="rgba(10,50,120,.82)"/>
                    </radialGradient>
                    <filter id="softShadowR" x="-30%" y="-30%" width="160%" height="160%">
                      <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(0,0,0,.25)"/>
                    </filter>
                  </defs>

                  <path filter="url(#softShadowR)"
                    d="M150 34
                       C210 40,252 84,256 146
                       C259 198,242 236,222 262
                       C210 278,208 300,214 320
                       C225 356,205 392,150 404
                       C112 398,90 372,84 344
                       C78 316,86 288,94 266
                       C70 236,56 202,60 160
                       C64 94,100 42,150 34 Z"
                    fill="url(#skinGradR)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>

                  <ellipse cx="100" cy="210" rx="18" ry="26" fill="rgba(255,255,255,.10)"/>

                  <g class="zones">
                    <path class="zone" data-zone="tempia_dx"
                      d="M228 150 C220 120,198 104,174 108 C182 142,184 170,174 198 C200 198,220 184,228 150 Z"/>
                    <path class="zone" data-zone="occipite_dx"
                      d="M160 108 C130 112,106 142,102 184 C122 174,140 176,154 186 C162 162,164 136,160 108 Z"/>
                    <path class="zone" data-zone="mandibola_dx"
                      d="M206 258 C188 238,166 240,152 254 C154 290,184 300,206 258 Z"/>
                    <path class="zone" data-zone="cervicale"
                      d="M136 304 C148 288,186 290,196 306 C190 342,140 342,136 304 Z"/>
                  </g>
                </svg>
              </div>
            </div>

            <div class="painmap-footer">
              <div class="small"><strong>Selezione:</strong> <span id="painSelectionText">‚Äî</span></div>
              <div class="hint">Suggerimento: se non vuoi indicare la sede, lascia ‚Äú‚Äî‚Äù.</div>
            </div>
          </div>

          <div class="field">
            <label class="label" for="notes">Note (opzionale)</label>
            <textarea id="notes" class="input textarea" rows="3" placeholder="Es. nausea, fotofobia, riposo a letto..."></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salva attacco</button>
            <button id="btnClear" type="button" class="btn btn-ghost">Svuota campi</button>
          </div>
        </form>
      </div>

      <div class="card" id="card-registro">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Registro</h2>
            <p class="muted">Filtra per weekend/feriali e cerca per parole chiave. Il mese √® quello in alto.</p>
          </div>
          <div id="stats" class="stats-inline"></div>
        </div>

        <div class="filters">
          <div class="filter-row">
            <div class="field">
              <label class="label" for="onlyWeekend">Filtro</label>
              <select id="onlyWeekend" class="input">
                <option value="all" selected>Tutti</option>
                <option value="weekend">Solo weekend</option>
                <option value="weekday">Solo feriali</option>
              </select>
            </div>

            <div class="field grow">
              <label class="label" for="q">Cerca</label>
              <input id="q" class="input" type="text" placeholder="Relpax, nausea, Tempia, 2025-11-12..." />
            </div>

            <div class="field actions">
              <label class="label">Azioni</label>
              <div class="btn-row">
                <button id="btnExportMonth" type="button" class="btn btn-ghost">Esporta CSV mese</button>
                <button id="btnExportAll" type="button" class="btn btn-ghost">Esporta CSV tutto</button>
                <button id="btnDeleteAll" type="button" class="btn btn-danger">Cancella tutto</button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Intensit√†</th>
                <th>Durata</th>
                <th>Farmaci</th>
                <th>Risposta</th>
                <th>Trigger / Sede</th>
                <th>Note</th>
                <th style="text-align:right">Azioni</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div id="cards" class="cards"></div>
      </div>
    </section>

    <!-- =======================
         STATISTICHE
         ======================= -->
    <section id="view-statistiche" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Statistiche</h2>
            <p class="muted">Grafici mensili (leggibili anche in stampa PDF). Il mese √® quello in alto.</p>
          </div>
          <button id="btnRefreshCharts" class="btn btn-ghost" type="button">Aggiorna grafici</button>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-head">
              <h3>Intensit√† (max) giorno per giorno</h3>
              <span class="chip-soft">colore per severit√†</span>
            </div>
            <canvas id="chartIntensity" class="chart-canvas" aria-label="Grafico intensit√†"></canvas>
            <p class="hint">Barre: intensit√† massima del giorno (0 = nessun attacco).</p>
          </div>

          <div class="chart-card">
            <div class="chart-head">
              <h3>Trigger pi√π frequenti</h3>
              <span class="chip-soft">manuali + dedotti</span>
            </div>
            <canvas id="chartTriggers" class="chart-canvas" aria-label="Grafico trigger"></canvas>
            <p class="hint">Conteggio dei trigger selezionati o dedotti (stress alto, poco sonno...).</p>
          </div>

          <div class="chart-card">
            <div class="chart-head">
              <h3>Farmaci pi√π usati</h3>
              <span class="chip-soft">top 10</span>
            </div>
            <canvas id="chartMeds" class="chart-canvas" aria-label="Grafico farmaci"></canvas>
            <p class="hint">Conteggio dei farmaci assunti durante gli attacchi.</p>
          </div>

          <div class="chart-card">
            <div class="chart-head">
              <h3>Sedi del dolore pi√π frequenti</h3>
              <span class="chip-soft">top 10</span>
            </div>
            <canvas id="chartPainZones" class="chart-canvas" aria-label="Grafico sedi dolore"></canvas>
            <p class="hint">Conteggio delle zone selezionate nella mappa testa.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- =======================
         REPORT PDF
         ======================= -->
    <section id="view-report" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Report mensile (PDF / Condivisione)</h2>
            <p class="muted">La data globale e il mese in alto aggiornano automaticamente questa tabella.</p>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button id="btnPrintReportTop" type="button" class="btn btn-ghost">Stampa</button>
            <button id="btnSharePdfTop" type="button" class="btn btn-primary">Condividi PDF (WhatsApp)</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Giorno</th>
                <th>Intensit√†</th>
                <th>Durata</th>
                <th>Farmaci</th>
                <th>Risposta</th>
                <th>Note / Trigger / Sede</th>
                <th style="text-align:right">Azioni</th>
              </tr>
            </thead>
            <tbody id="monthlyRows"></tbody>
          </table>
        </div>

        <div class="footer-actions">
          <div class="hint">
            ‚ÄúCondividi PDF‚Äù apre il pannello di condivisione Android: scegli WhatsApp e poi la chat.
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button id="btnPrintReportBottom" type="button" class="btn btn-ghost">Stampa</button>
            <button id="btnSharePdfBottom" type="button" class="btn btn-primary">Condividi PDF (WhatsApp)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- =======================
         IMPOSTAZIONI
         ======================= -->
    <section id="view-impostazioni" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Impostazioni</h2>
            <p class="muted">Nome in intestazione del report e backup/import dati.</p>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label class="label" for="patientName">Nome e Cognome (per intestazione Report)</label>
            <input id="patientName" class="input" type="text" placeholder="Es. Mario Rossi" />
            <div class="hint">Il nome verr√† mostrato nel PDF insieme a ‚ÄúDr.ssa Maria Albanese‚Äù.</div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label class="label">Backup</label>
            <button id="btnBackup" class="btn btn-ghost" type="button">Scarica backup JSON</button>
            <div class="hint">Salva tutti i dati in un file JSON.</div>
          </div>

          <div class="field">
            <label class="label" for="fileImport">Import</label>
            <input id="fileImport" class="input" type="file" accept="application/json" />
            <div class="hint">Importa un backup JSON (unisce i dati esistenti).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="./app.js"></script>
</body>
</html>

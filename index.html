<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Diario Cefalea</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <img class="logo" src="./assets/ptv.png" alt="Fondazione PTV" />
      <div class="brand-text">
        <div class="brand-title">Diario Cefalea</div>
        <div class="brand-subtitle">Registro ‚Ä¢ Trigger ‚Ä¢ Grafici ‚Ä¢ Report PDF</div>
      </div>
    </div>

    <div class="header-actions">
      <button id="btnInstall" class="btn btn-ghost" hidden>‚¨áÔ∏è Installa</button>

      <!-- ‚úÖ Data globale: guida tutte le schede -->
      <div class="header-field">
        <div class="label">Data</div>
        <input id="globalDate" type="date" class="input" />
      </div>

      <div class="header-field">
        <div class="label">Mese</div>
        <input id="month" type="month" class="input" />
      </div>

      <div class="header-field">
        <div class="label">Tema</div>
        <select id="themeSelect" class="input">
          <option value="auto">Auto</option>
          <option value="dark">Scuro</option>
          <option value="light">Chiaro</option>
        </select>
      </div>
    </div>
  </header>

  <nav class="tabs" aria-label="Navigazione">
    <button class="tab active" data-view="diario" data-accent="blue" type="button">
      <span class="tab-ico">üìù</span><span>Diario</span>
    </button>
    <button class="tab" data-view="statistiche" data-accent="cyan" type="button">
      <span class="tab-ico">üìä</span><span>Statistiche</span>
    </button>
    <button class="tab" data-view="report" data-accent="amber" type="button">
      <span class="tab-ico">üßæ</span><span>Report PDF</span>
    </button>
    <button class="tab" data-view="impostazioni" data-accent="violet" type="button">
      <span class="tab-ico">‚öôÔ∏è</span><span>Impostazioni</span>
    </button>
  </nav>

  <main class="container">
    <!-- =======================
         DIARIO
         ======================= -->
    <section id="view-diario" class="view active">
      <div class="card" id="card-form">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Inserisci attacco</h2>
            <p class="muted">Compila i campi principali e aggiungi trigger / note se necessario.</p>
          </div>
          <div class="pill">Touch-friendly</div>
        </div>

        <form id="attackForm" class="form">
          <div class="grid">
            <div class="field">
              <label class="label" for="date">Data</label>
              <input id="date" class="input" type="date" />
              <div class="hint">Suggerimento: la data qui aggiorna automaticamente anche la data globale.</div>
            </div>

            <div class="field">
              <label class="label" for="time">Ora (opzionale)</label>
              <input id="time" class="input" type="time" />
            </div>

            <div class="field">
              <label class="label" for="intensity">Intensit√† (1‚Äì10)</label>
              <input id="intensity" class="input" type="number" min="1" max="10" step="1" placeholder="Es. 7" />
            </div>

            <div class="field">
              <label class="label" for="duration">Durata (ore)</label>
              <input id="duration" class="input" type="number" min="0.5" step="0.5" placeholder="Es. 6" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="meds">Farmaci assunti (selezione multipla)</label>
            <select id="meds" class="input" multiple size="6">
              <option value="Relpax">Relpax</option>
              <option value="Okitask (FANS)">Okitask (FANS)</option>
              <option value="Ibuprofene (FANS)">Ibuprofene (FANS)</option>
              <option value="Naproxene (FANS)">Naproxene (FANS)</option>
              <option value="Paracetamolo">Paracetamolo</option>
              <option value="Altro (FANS)">Altro (FANS)</option>
              <option value="Nessuno">Nessuno</option>
            </select>
            <div class="hint">Tip: su Android puoi tenere premuto e selezionare pi√π opzioni.</div>
          </div>

          <div class="grid">
            <div class="field">
              <label class="label" for="efficacy">Risposta ai farmaci</label>
              <select id="efficacy" class="input">
                <option value="Nessuna">Nessuna</option>
                <option value="Parziale" selected>Parziale</option>
                <option value="Buona">Buona</option>
                <option value="Ottima">Ottima</option>
              </select>
            </div>

            <div class="field">
              <label class="label" for="stress">Stress (0‚Äì10) <span class="badge-mini" id="stressVal">0</span></label>
              <input id="stress" class="input" type="range" min="0" max="10" step="1" value="0" />
              <div class="hint">Valore indicativo (pi√π alto = pi√π stress).</div>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <label class="label" for="sleepHours">Ore di sonno (opzionale)</label>
              <input id="sleepHours" class="input" type="number" min="0" max="24" step="0.5" placeholder="Es. 5.5" />
            </div>
            <div class="field">
              <label class="label" for="weather">Meteo (opzionale)</label>
              <input id="weather" class="input" type="text" placeholder="Es. pioggia / sbalzo temperatura" />
            </div>
            <div class="field">
              <label class="label" for="foods">Alimenti (opzionale)</label>
              <input id="foods" class="input" type="text" placeholder="Es. cioccolato, vino, salumi..." />
            </div>
          </div>

          <div class="field">
            <label class="label">Trigger (spuntare se presenti)</label>
            <div id="triggerChips" class="chips">
              <label class="chip"><input type="checkbox" value="Stress" /> Stress</label>
              <label class="chip"><input type="checkbox" value="Poco sonno" /> Poco sonno</label>
              <label class="chip"><input type="checkbox" value="Meteo" /> Meteo</label>
              <label class="chip"><input type="checkbox" value="Alimenti" /> Alimenti</label>
              <label class="chip"><input type="checkbox" value="Luci/Schermi" /> Luci/Schermi</label>
              <label class="chip"><input type="checkbox" value="Rumore" /> Rumore</label>
              <label class="chip"><input type="checkbox" value="Fatica" /> Fatica</label>
              <label class="chip"><input type="checkbox" value="Ciclo/Ormoni" /> Ciclo/Ormoni</label>
              <label class="chip"><input type="checkbox" value="Collo/Tensione" /> Collo/Tensione</label>
            </div>
            <div class="hint">Nota: alcuni trigger possono essere dedotti automaticamente (es. stress alto, poco sonno).</div>
          </div>

          <div class="field">
            <label class="label" for="notes">Note (opzionale)</label>
            <textarea id="notes" class="input textarea" rows="3" placeholder="Es. nausea, fotofobia, riposo a letto..."></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salva attacco</button>
            <button id="btnClear" type="button" class="btn btn-ghost">Svuota campi</button>
          </div>
        </form>
      </div>

      <div class="card" id="card-registro">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Registro</h2>
            <p class="muted">Filtra per weekend/feriali e cerca per parole chiave. Il mese √® quello in alto.</p>
          </div>
          <div id="stats" class="stats-inline"></div>
        </div>

        <div class="filters">
          <div class="filter-row">
            <div class="field">
              <label class="label" for="onlyWeekend">Filtro</label>
              <select id="onlyWeekend" class="input">
                <option value="all" selected>Tutti</option>
                <option value="weekend">Solo weekend</option>
                <option value="weekday">Solo feriali</option>
              </select>
            </div>

            <div class="field grow">
              <label class="label" for="q">Cerca</label>
              <input id="q" class="input" type="text" placeholder="Relpax, nausea, Meteo, 2025-11-12..." />
            </div>

            <div class="field actions">
              <label class="label">Azioni</label>
              <div class="btn-row">
                <button id="btnExportMonth" type="button" class="btn btn-ghost">Esporta CSV mese</button>
                <button id="btnExportAll" type="button" class="btn btn-ghost">Esporta CSV tutto</button>
                <button id="btnDeleteAll" type="button" class="btn btn-danger">Cancella tutto</button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Intensit√†</th>
                <th>Durata</th>
                <th>Farmaci</th>
                <th>Risposta</th>
                <th>Trigger</th>
                <th>Note</th>
                <th style="text-align:right">Azioni</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div id="cards" class="cards"></div>
      </div>
    </section>

    <!-- =======================
         STATISTICHE
         ======================= -->
    <section id="view-statistiche" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Statistiche</h2>
            <p class="muted">Grafici mensili (leggibili anche in stampa PDF). Il mese √® quello in alto.</p>
          </div>
          <button id="btnRefreshCharts" class="btn btn-ghost" type="button">Aggiorna grafici</button>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-head">
              <h3>Intensit√† (max) giorno per giorno</h3>
              <span class="chip-soft">tutti i giorni visibili</span>
            </div>
            <canvas id="chartIntensity" class="chart-canvas" aria-label="Grafico intensit√†"></canvas>
            <p class="hint">Barre: intensit√† massima del giorno (0 = nessun attacco).</p>
          </div>

          <div class="chart-card">
            <div class="chart-head">
              <h3>Trigger pi√π frequenti</h3>
              <span class="chip-soft">manuali + dedotti</span>
            </div>
            <canvas id="chartTriggers" class="chart-canvas" aria-label="Grafico trigger"></canvas>
            <p class="hint">Conteggio dei trigger selezionati o dedotti (stress alto, poco sonno...).</p>
          </div>

          <div class="chart-card">
            <div class="chart-head">
              <h3>Farmaci pi√π usati</h3>
              <span class="chip-soft">top 10</span>
            </div>
            <canvas id="chartMeds" class="chart-canvas" aria-label="Grafico farmaci"></canvas>
            <p class="hint">Conteggio dei farmaci assunti durante gli attacchi.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- =======================
         REPORT PDF
         ======================= -->
    <section id="view-report" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Report mensile (PDF / Condivisione)</h2>
            <p class="muted">La data globale e il mese in alto aggiornano automaticamente questa tabella.</p>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button id="btnPrintReportTop" type="button" class="btn btn-ghost">Stampa</button>
            <button id="btnSharePdfTop" type="button" class="btn btn-primary">Condividi PDF (WhatsApp)</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Giorno</th>
                <th>Intensit√†</th>
                <th>Durata</th>
                <th>Farmaci</th>
                <th>Risposta</th>
                <th>Note / Trigger</th>
                <th style="text-align:right">Azioni</th>
              </tr>
            </thead>
            <tbody id="monthlyRows"></tbody>
          </table>
        </div>

        <div class="footer-actions">
          <div class="hint">
            ‚ÄúCondividi PDF‚Äù apre il pannello di condivisione Android: scegli WhatsApp e poi la chat.
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button id="btnPrintReportBottom" type="button" class="btn btn-ghost">Stampa</button>
            <button id="btnSharePdfBottom" type="button" class="btn btn-primary">Condividi PDF (WhatsApp)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- =======================
         IMPOSTAZIONI
         ======================= -->
    <section id="view-impostazioni" class="view">
      <div class="card">
        <div class="section-title">
          <div class="section-title-left">
            <h2>Impostazioni</h2>
            <p class="muted">Nome in intestazione del report e backup/import dati.</p>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label class="label" for="patientName">Nome e Cognome (per intestazione Report)</label>
            <input id="patientName" class="input" type="text" placeholder="Es. Mario Rossi" />
            <div class="hint">Il nome verr√† mostrato nel PDF insieme a ‚ÄúDr.ssa Maria Albanese‚Äù.</div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label class="label">Backup</label>
            <button id="btnBackup" class="btn btn-ghost" type="button">Scarica backup JSON</button>
            <div class="hint">Salva tutti i dati in un file JSON.</div>
          </div>

          <div class="field">
            <label class="label" for="fileImport">Import</label>
            <input id="fileImport" class="input" type="file" accept="application/json" />
            <div class="hint">Importa un backup JSON (unisce i dati esistenti).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ‚úÖ jsPDF per generare un file PDF reale (da condividere su WhatsApp) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="./app.js"></script>
</body>
</html>
